local player = game.Players.LocalPlayer
local camera = workspace.CurrentCamera
local espEnabled = false
local fovEnabled = false
local aimbotEnabled = false
local itemEspEnabled = false  -- Nueva variable para Item ESP
local fovSize = 200
local espObjects = {}
local itemEspObjects = {}  -- Nueva tabla para objetos de Item ESP
local targets = {}
local items = {}  -- Nueva tabla para items
local dragging = false
local dragStart, startPos
local userInputService = game:GetService("UserInputService")
local runService = game:GetService("RunService")
local lockedTarget = nil  -- Nueva variable para lock-on del aimbot
local inventoryFrame = nil  -- Nueva variable para el mini frame del inventario

local gui = Instance.new("ScreenGui")
gui.Name = "AdvancedESPGui"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 240, 0, 100)  -- Expandido para acomodar el nuevo botón
frame.Position = UDim2.new(0.02, 0, 0.85, 0)
frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
frame.BackgroundTransparency = 0
frame.Active = true
frame.Parent = gui

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(20, 20, 20)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(60, 60, 60))
}
gradient.Parent = frame

local function makeButton(text, xPos, yPos, sizeX, sizeY)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, sizeX or 60, 0, sizeY or 50)
    btn.Position = UDim2.new(0, xPos, 0, yPos)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.BackgroundTransparency = 0.5
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    btn.Text = text
    btn.Parent = frame
    return btn
end

local espButton = makeButton("ESP", 0, 0)
local fovButton = makeButton("FOV", 60, 0)
local aimbotButton = makeButton("Aim", 120, 0)
local itemEspButton = makeButton("Item ESP", 180, 0)  -- Nuevo botón para Item ESP
local plusButton = makeButton("+", 0, 50, 30, 50)
local minusButton = makeButton("-", 30, 50, 30, 50)
local closeButton = makeButton("X", 60, 50, 180, 50)  -- Ajustado para ocupar el espacio restante

local fovCircle = Instance.new("Frame")
fovCircle.Name = "FOVCircle"
fovCircle.Size = UDim2.new(0, fovSize * 2, 0, fovSize * 2)
fovCircle.AnchorPoint = Vector2.new(0.5, 0.5)
fovCircle.Position = UDim2.new(0.5, 0, 0.5, 0)
fovCircle.BackgroundTransparency = 1
fovCircle.Visible = false
fovCircle.Parent = gui

local stroke = Instance.new("UIStroke")
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(255, 255, 255)
stroke.Parent = fovCircle

local circleCorner = Instance.new("UICorner")
circleCorner.CornerRadius = UDim.new(1, 0)
circleCorner.Parent = fovCircle

-- Implementar dragging manualmente para el frame
frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

userInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

local function updateTargets()
    targets = {}
    for _, plr in ipairs(game.Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("Head") and plr.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(targets, plr.Character)
        end
    end
end

local function updateItems()
    items = {}
    local droppedItems = workspace:FindFirstChild("DroppedItems")
    if droppedItems then
        for _, item in ipairs(droppedItems:GetChildren()) do
            if item:IsA("Model") and item.PrimaryPart then
                table.insert(items, item)
            elseif item:IsA("BasePart") then
                table.insert(items, item)
            end
        end
    end
end

local function createBillboard(target)
    if not target or not target:FindFirstChild("Head") or not target:FindFirstChild("HumanoidRootPart") then return end
    if espObjects[target] then return end  -- Evitar duplicados

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPTag"
    billboard.Adornee = target.Head
    billboard.AlwaysOnTop = true
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.Gotham
    label.TextSize = 16
    label.TextStrokeTransparency = 0
    label.TextStrokeColor3 = Color3.new(0, 0, 0)
    label.Parent = billboard

    billboard.Parent = target
    espObjects[target] = {billboard = billboard, label = label}

    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Adornee = target
    highlight.FillTransparency = 0.3
    highlight.FillColor = Color3.fromRGB(255, 0, 0)
    highlight.OutlineTransparency = 1
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = target
    espObjects[target].highlight = highlight

    local tracer = Drawing.new("Line")
    tracer.Thickness = 2
    tracer.Color = Color3.fromRGB(255, 0, 0)
    tracer.Transparency = 0.5
    tracer.Visible = false  -- Inicialmente invisible
    espObjects[target].tracer = tracer

    -- Loop para actualizar texto y verificar existencia
    task.spawn(function()
        while espEnabled and target.Parent and target:FindFirstChild("HumanoidRootPart") and target:FindFirstChild("Head") do
            local dist = 0
            local health = 0
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                dist = math.floor((player.Character.HumanoidRootPart.Position - target.HumanoidRootPart.Position).Magnitude)
            end
            if target:FindFirstChildOfClass("Humanoid") then
                health = math.floor(target.Humanoid.Health)
            end
            label.Text = string.format("%s [%dm] [%d HP]", target.Name, dist, health)
            task.wait(0.05)
        end
        -- Limpiar cuando termine
        if billboard then billboard:Destroy() end
        if highlight then highlight:Destroy() end
        if tracer then tracer:Remove() end
        espObjects[target] = nil
    end)
end

local function createBillboardForItem(item)
    if itemEspObjects[item] then return end  -- Evitar duplicados

    local adornee = item:IsA("Model") and item.PrimaryPart or item
    if not adornee then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ItemESPTag"
    billboard.Adornee = adornee
    billboard.AlwaysOnTop = true
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.Gotham
    label.TextSize = 16
    label.TextStrokeTransparency = 0
    label.TextStrokeColor3 = Color3.new(0, 0, 0)
    label.TextColor3 = Color3.fromRGB(255, 255, 0)  -- Amarillo
    label.Parent = billboard

    billboard.Parent = item
    itemEspObjects[item] = {billboard = billboard, label = label}

    local highlight = Instance.new("Highlight")
    highlight.Name = "ItemESPHighlight"
    highlight.Adornee = item
    highlight.FillTransparency = 0.3
    highlight.FillColor = Color3.fromRGB(255, 255, 0)  -- Amarillo
    highlight.OutlineTransparency = 1
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = item
    itemEspObjects[item].highlight = highlight

    local tracer = Drawing.new("Line")
    tracer.Thickness = 2
    tracer.Color = Color3.fromRGB(255, 255, 0)  -- Amarillo
    tracer.Transparency = 0.5
    tracer.Visible = false  -- Inicialmente invisible
    itemEspObjects[item].tracer = tracer

    -- Loop para actualizar texto y verificar existencia
    task.spawn(function()
        while itemEspEnabled and item.Parent do
            local dist = 0
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                dist = math.floor((player.Character.HumanoidRootPart.Position - adornee.Position).Magnitude)
            end
            label.Text = string.format("%s [%dm]", item.Name, dist)
            task.wait(0.05)
        end
        -- Limpiar cuando termine
        if billboard then billboard:Destroy() end
        if highlight then highlight:Destroy() end
        if tracer then tracer:Remove() end
        itemEspObjects[item] = nil
    end)
end

local function toggleESP()
    espEnabled = not espEnabled
    for target, objs in pairs(espObjects) do
        if objs.billboard then objs.billboard:Destroy() end
        if objs.highlight then objs.highlight:Destroy() end
        if objs.tracer then objs.tracer:Remove() end
    end
    espObjects = {}

    if espEnabled then
        updateTargets()
        for _, target in ipairs(targets) do
            createBillboard(target)
        end
    end
end
espButton.MouseButton1Click:Connect(toggleESP)

local function toggleItemESP()
    itemEspEnabled = not itemEspEnabled
    for item, objs in pairs(itemEspObjects) do
        if objs.billboard then objs.billboard:Destroy() end
        if objs.highlight then objs.highlight:Destroy() end
        if objs.tracer then objs.tracer:Remove() end
    end
    itemEspObjects = {}

    if itemEspEnabled then
        updateItems()
        for _, item in ipairs(items) do
            createBillboardForItem(item)
        end
    end
end
itemEspButton.MouseButton1Click:Connect(toggleItemESP)

local function toggleFOV()
    fovEnabled = not fovEnabled
    fovCircle.Visible = fovEnabled
end
fovButton.MouseButton1Click:Connect(toggleFOV)

local function resizeFOV(increase)
    if not fovEnabled then return end
    if increase then
        fovSize = math.min(500, fovSize + 20)
    else
        fovSize = math.max(50, fovSize - 20)
    end
    fovCircle.Size = UDim2.new(0, fovSize * 2, 0, fovSize * 2)
end
plusButton.MouseButton1Click:Connect(function() resizeFOV(true) end)
minusButton.MouseButton1Click:Connect(function() resizeFOV(false) end)

local function toggleAimbot()
    aimbotEnabled = not aimbotEnabled
end
aimbotButton.MouseButton1Click:Connect(toggleAimbot)

closeButton.MouseButton1Click:Connect(function()
    gui:Destroy()
end)

-- Nueva función para detectar inputs de teclado
userInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.C then
        toggleESP()
    elseif input.KeyCode == Enum.KeyCode.X then
        toggleAimbot()
    elseif input.KeyCode == Enum.KeyCode.P then  -- Nueva tecla para Item ESP
        toggleItemESP()
    end
end)

-- Nueva función para crear el mini frame del inventario
local function createInventoryFrame(targetPlayer)
    if inventoryFrame then inventoryFrame:Destroy() end
    inventoryFrame = Instance.new("Frame")
    inventoryFrame.Size = UDim2.new(0, 200, 0, 300)
    inventoryFrame.Position = UDim2.new(0, 10, 0.5, -150)  -- A la izquierda, centrado verticalmente
    inventoryFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    inventoryFrame.BackgroundTransparency = 0.5
    inventoryFrame.Parent = gui

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 0, 30)
    titleLabel.Position = UDim2.new(0, 0, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Font = Enum.Font.Gotham
    titleLabel.TextSize = 18
    titleLabel.Text = "Inventario de " .. targetPlayer.Name
    titleLabel.Parent = inventoryFrame

    local scrollingFrame = Instance.new("ScrollingFrame")
    scrollingFrame.Size = UDim2.new(1, 0, 1, -30)
    scrollingFrame.Position = UDim2.new(0, 0, 0, 30)
    scrollingFrame.BackgroundTransparency = 1
    scrollingFrame.ScrollBarThickness = 10
    scrollingFrame.Parent = inventoryFrame

    local listLayout = Instance.new("UIListLayout")
    listLayout.Parent = scrollingFrame
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder

    -- Obtener inventario
    local inventoryFolder = game.ReplicatedStorage.Players:FindFirstChild(targetPlayer.Name):FindFirstChild("Inventory")
    if inventoryFolder then
        local children = inventoryFolder:GetChildren()
        if #children > 0 then
            for _, itemObj in ipairs(children) do
                if itemObj:IsA("ObjectValue") then
                    local itemLabel = Instance.new("TextLabel")
                    itemLabel.Size = UDim2.new(1, 0, 0, 25)
                    itemLabel.BackgroundTransparency = 1
                    itemLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                    itemLabel.Font = Enum.Font.Gotham
                    itemLabel.TextSize = 14
                    itemLabel.Text = itemObj.Name  -- Solo el nombre del ObjectValue
                    itemLabel.Parent = scrollingFrame
                end
            end
        else
            -- Si no hay items, mostrar mensaje
            local noItemsLabel = Instance.new("TextLabel")
            noItemsLabel.Size = UDim2.new(1, 0, 0, 25)
            noItemsLabel.BackgroundTransparency = 1
            noItemsLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            noItemsLabel.Font = Enum.Font.Gotham
            noItemsLabel.TextSize = 14
            noItemsLabel.Text = "Inventario vacío"
            noItemsLabel.Parent = scrollingFrame
        end
    else
        -- Si no se encuentra el folder, mostrar mensaje
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Size = UDim2.new(1, 0, 0, 25)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        errorLabel.Font = Enum.Font.Gotham
        errorLabel.TextSize = 14
        errorLabel.Text = "No se pudo acceder al inventario"
        errorLabel.Parent = scrollingFrame
    end
end

-- Nueva función para destruir el mini frame del inventario
local function destroyInventoryFrame()
    if inventoryFrame then
        inventoryFrame:Destroy()
        inventoryFrame = nil
    end
end

local time = 0
runService.RenderStepped:Connect(function(dt)
    time = time + dt
    local rgbColor = Color3.fromHSV(time % 1, 1, 1)
    local screenSize = camera.ViewportSize
    local center = Vector2.new(screenSize.X / 2, screenSize.Y / 2)

    if aimbotEnabled and userInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
        if not lockedTarget then
            -- Buscar el mejor target para lockear
            local bestTarget = nil
            local bestDist = math.huge
            for _, target in ipairs(targets) do
                if target.Parent and target:FindFirstChild("Head") and target:FindFirstChild("HumanoidRootPart") then
                    local screenPos, onScreen = camera:WorldToViewportPoint(target.Head.Position)
                    if onScreen and screenPos.Z > 0 then
                        local dist = (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude
                        if dist <= fovSize and dist < bestDist then
                            bestDist = dist
                            bestTarget = target
                        end
                    end
                end
            end
            lockedTarget = bestTarget
            if lockedTarget then
                -- Crear el mini frame del inventario
                local targetPlayer = game.Players:GetPlayerFromCharacter(lockedTarget)
                if targetPlayer then
                    createInventoryFrame(targetPlayer)
                end
            end
        end

        if lockedTarget and lockedTarget.Parent and lockedTarget:FindFirstChild("Head") and lockedTarget:FindFirstChild("HumanoidRootPart") then
            local targetPos = lockedTarget.Head.Position + (lockedTarget.HumanoidRootPart.Velocity * 0.1)
            local desiredCFrame = CFrame.lookAt(camera.CFrame.Position, targetPos)
            camera.CFrame = camera.CFrame:Lerp(desiredCFrame, 0.15)
        else
            lockedTarget = nil  -- Reset si el target ya no es válido
            destroyInventoryFrame()  -- Destruir el frame si no hay target
        end
    else
        lockedTarget = nil  -- Deslockear al soltar RMB
        destroyInventoryFrame()  -- Destruir el frame al deslockear
    end

    if espEnabled then
        -- Actualizar targets automáticamente
        updateTargets()

        for _, target in ipairs(targets) do
            if not espObjects[target] then
                createBillboard(target)
            end

            if espObjects[target] and espObjects[target].label then
                espObjects[target].label.TextColor3 = rgbColor
            end

            if espObjects[target] and espObjects[target].tracer then
                local targetTorsoPos, onScreen = camera:WorldToViewportPoint(target.HumanoidRootPart.Position)
                if onScreen then
                    local targetVec = Vector2.new(targetTorsoPos.X, targetTorsoPos.Y)
                    espObjects[target].tracer.From = center  -- Corregido: desde el centro de la pantalla
                    espObjects[target].tracer.To = targetVec
                    espObjects[target].tracer.Visible = true
                else
                    espObjects[target].tracer.Visible = false
                end
            end
        end

        -- Limpiar espObjects para targets que ya no existen
        for target, objs in pairs(espObjects) do
            if not table.find(targets, target) or not target.Parent or not target:FindFirstChild("HumanoidRootPart") then
                if objs.billboard then objs.billboard:Destroy() end
                if objs.highlight then objs.highlight:Destroy() end
                if objs.tracer then objs.tracer:Remove() end
                espObjects[target] = nil
            end
        end
    end

    if itemEspEnabled then
        -- Actualizar items automáticamente
        updateItems()

        for _, item in ipairs(items) do
            if not itemEspObjects[item] then
                createBillboardForItem(item)
            end

            if itemEspObjects[item] and itemEspObjects[item].tracer then
                local adornee = item:IsA("Model") and item.PrimaryPart or item
                if adornee then
                    local itemPos, onScreen = camera:WorldToViewportPoint(adornee.Position)
                    if onScreen then
                        local itemVec = Vector2.new(itemPos.X, itemPos.Y)
                        itemEspObjects[item].tracer.From = center
                        itemEspObjects[item].tracer.To = itemVec
                        itemEspObjects[item].tracer.Visible = true
                    else
                        itemEspObjects[item].tracer.Visible = false
                    end
                end
            end
        end

        -- Limpiar itemEspObjects para items que ya no existen
        for item, objs in pairs(itemEspObjects) do
            if not table.find(items, item) or not item.Parent then
                if objs.billboard then objs.billboard:Destroy() end
                if objs.highlight then objs.highlight:Destroy() end
                if objs.tracer then objs.tracer:Remove() end
                itemEspObjects[item] = nil
            end
        end
    end
end)

-- Eventos para actualizar ESP automáticamente
game.Players.PlayerAdded:Connect(function(plr)
    if espEnabled and plr ~= player then
        plr.CharacterAdded:Connect(function(char)
            updateTargets()
            createBillboard(char)
        end)
        if plr.Character then
            updateTargets()
            createBillboard(plr.Character)
        end
    end
end)

game.Players.PlayerRemoving:Connect(function(plr)
    if espEnabled then
        updateTargets()
    end
end)

-- Evento para actualizar items automáticamente (si es necesario)
workspace.ChildAdded:Connect(function(child)
    if itemEspEnabled and child.Name == "DroppedItems" then
        updateItems()
    end
end)
